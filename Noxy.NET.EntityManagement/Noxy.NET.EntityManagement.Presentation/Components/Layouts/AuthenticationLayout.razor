@inject UserAuthenticationStateProvider AuthProvider
@inject UserAuthenticationService AuthService
@inject IState<FeatureTextState> State
@inherits LayoutComponentBase
@implements IDisposable

<Loader Loading="!AuthProvider.IsInitialized">
    <AuthorizeView>
        <Authorized>
            @Body
        </Authorized>
        <NotAuthorized>
            <FormAuthentication/>
        </NotAuthorized>
    </AuthorizeView>
</Loader>

@code {

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await AuthService.Renew();
    }

    protected override void OnInitialized()
    {
        State.StateChanged += OnStateChanged;
        AuthProvider.AuthenticationStateChanged += OnAuthStateChanged;
    }

    private void OnAuthStateChanged(Task<AuthenticationState> _)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        State.StateChanged -= OnStateChanged;
        AuthProvider.AuthenticationStateChanged -= OnAuthStateChanged;
    }

}
