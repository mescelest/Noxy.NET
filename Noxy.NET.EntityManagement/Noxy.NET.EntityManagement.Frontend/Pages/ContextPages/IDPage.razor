@page "/Context/{identifier}"
@inject APIHttpClient APIHttpClient
@inject TextService TextService
@inherits PageComponent

<PageTitle>Home | @_entityContext?.Title</PageTitle>

<PageLayout>
    @if (IsRendered)
    {
        <MagazineLayout>
            <Content>
                <ElementPanel List="_listElement"/>
            </Content>
        </MagazineLayout>
    }
    else
    {
        <span>Loading...</span>
    }
</PageLayout>

@code {

    [Parameter]
    public string Identifier { get; set; } = string.Empty;

    private ViewModelSchemaContext? _entityContext;
    private ViewModelDataElement[] _listElement = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (!firstRender) return;

        await WithLoading(LoadData);
        await WithLoading(TextService.Resolve);
    }

    private async Task OnActionPanelActionComplete()
    {
        await WithLoading(LoadData);
        await WithLoading(TextService.Resolve);
    }

    private async Task LoadData()
    {
        await LoadContext();
        await LoadElement();
    }

    private async Task LoadContext()
    {
        _entityContext = await APIHttpClient.SendRequest<ViewModelSchemaContext>(HttpMethod.Get, $"Data/Context/{Identifier}");
    }

    private async Task LoadElement()
    {
        _listElement = await APIHttpClient.SendRequest<ViewModelDataElement[]>(HttpMethod.Get, $"Data/Context/{Identifier}/Element");
    }

}
