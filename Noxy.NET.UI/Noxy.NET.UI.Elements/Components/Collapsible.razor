@inject IJSRuntime JS
@inherits ElementComponent
@implements IAsyncDisposable

<div @attributes="@AdditionalAttributes" id="@UUIDCode" class="@CssClass" collapsed="@_isCollapsed">
    <div class="header-wrapper">
        @Header

        <div class="arrow" tabindex="0" @onclick="ArrowClicked" @onkeydown="ArrowKeyPressed">

            @if (LoadingCurrent)
            {
                <span>LOADING</span>
                @* <Loader Width="40" Height="40"/>  *@
            }
            else if (Arrow != null)
            {
                @Arrow(EffectiveCollapsed)
            }
            else
            {
                @if (EffectiveCollapsed)
                {
                    <IconChevronDown Size="IconSizeEnum.Small"/>
                }
                else
                {
                    <IconChevronUp Size="IconSizeEnum.Small"/>
                }
            }
        </div>
    </div>

    <div class="content-wrapper" @ref="_refContentWrapper">
        @Content
    </div>
</div>

@code {

    [Parameter]
    public RenderFragment? Header { get; set; }

    [Parameter]
    public RenderFragment? Content { get; set; }

    [Parameter]
    public RenderFragment<bool>? Arrow { get; set; }

    [Parameter]
    public bool? Loading { get; set; }
    private bool LoadingCurrent => Loading ?? false;

    [Parameter]
    public bool? Collapsed { get; set; }
    private bool CollapsedCurrent => Collapsed ?? true;

    [Parameter]
    public EventCallback<bool> CollapsedChanged { get; set; }

    [Parameter]
    public Expression<Func<bool>>? CollapsedExpression { get; set; }

    private bool _wasLoading;
    private bool _isCollapsed;
    private bool? _isAnimating;
    private IJSObjectReference _module = null!;
    private DotNetObjectReference<Collapsible> _refDotNet = null!;
    private ElementReference _refContentWrapper;

    private bool EffectiveCollapsed => LoadingCurrent || _isCollapsed;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _isCollapsed = CollapsedCurrent;
    }

    protected override async Task OnAfterFirstRenderAsync()
    {
        await base.OnAfterFirstRenderAsync();

        _refDotNet = DotNetObjectReference.Create(this);
        _module = await JS.InvokeAsync<IJSObjectReference>("import", JS.GetComponentPath(typeof(Collapsible)));

        await _module.InvokeVoidAsync("RegisterCollapsible", UUIDCode, _isCollapsed, _refContentWrapper, _refDotNet, nameof(OnAnimationComplete));
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (LoadingCurrent)
        {
            _isCollapsed = true;
        }

        if (_wasLoading && !LoadingCurrent)
        {
            _isCollapsed = false;
            _ = Animate(false);
        }

        _wasLoading = LoadingCurrent;

        if (CollapsedCurrent != _isCollapsed)
        {
            if (_isAnimating.HasValue)
            {
                if (CollapsedCurrent == _isAnimating.Value)
                {
                    return;
                }

                if (CollapsedCurrent == _isAnimating.Value)
                {
                    _ = Animate(CollapsedCurrent);
                }
            }
            else
            {
                _ = Animate(CollapsedCurrent);
            }
        }
    }

    [JSInvokable]
    public async Task OnAnimationComplete(bool collapsed)
    {
        _isAnimating = null;
        _isCollapsed = collapsed;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ArrowKeyPressed(KeyboardEventArgs args)
    {
        if (args.Code is " " or "Enter")
        {
            await Toggle();
        }
    }

    private async Task ArrowClicked()
    {
        await Toggle();
    }

    private async Task Toggle()
    {
        await CollapsedChanged.InvokeAsync(!_isCollapsed);
        await Animate(_isCollapsed);
    }

    private async Task Animate(bool collapse)
    {
        _isAnimating = collapse;
        await _module.InvokeVoidAsync(collapse ? "AnimateExpand" : "AnimateCollapse", _refContentWrapper);
    }

    public async ValueTask DisposeAsync()
    {
        await _module.DisposeAsync();
        _refDotNet.Dispose();
    }

}
